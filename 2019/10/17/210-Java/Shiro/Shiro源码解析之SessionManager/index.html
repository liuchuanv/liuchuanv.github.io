<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://liuchuanv.github.io').hostname,
    root: '/',
    scheme: 'Pisces',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="了解 SessionManager类继承图   在IDEA中选择某个类，按 Shift+Ctrl+Alt+U生成类继承图；选择某个类，按 F4进入类 按Alt+7查看类的结构 按Alt+F7查看方法在哪里被调用了  使用上面三个快捷键快捷查看框架源码  ！！！记住上面的结构 SessionManager AbstractSessionManager在源码注释中已经说明该类过时了，为了全局过期时间这">
<meta name="keywords" content="源码解析">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro源码解析之SessionManager">
<meta property="og:url" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;2019&#x2F;10&#x2F;17&#x2F;210-Java&#x2F;Shiro&#x2F;Shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSessionManager&#x2F;index.html">
<meta property="og:site_name" content="代码无难事">
<meta property="og:description" content="了解 SessionManager类继承图   在IDEA中选择某个类，按 Shift+Ctrl+Alt+U生成类继承图；选择某个类，按 F4进入类 按Alt+7查看类的结构 按Alt+F7查看方法在哪里被调用了  使用上面三个快捷键快捷查看框架源码  ！！！记住上面的结构 SessionManager AbstractSessionManager在源码注释中已经说明该类过时了，为了全局过期时间这">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;DefaultWebSessionManager.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571280469834.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571280571702.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571281149103.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571281440243.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571281647315.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571281832489.png">
<meta property="og:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;1571282013982.png">
<meta property="og:updated_time" content="2019-10-30T01:28:36.549Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;liuchuanv.github.io&#x2F;blog&#x2F;images&#x2F;201910&#x2F;DefaultWebSessionManager.png">

<link rel="canonical" href="https://liuchuanv.github.io/2019/10/17/210-Java/Shiro/Shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSessionManager/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Shiro源码解析之SessionManager | 代码无难事</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">代码无难事</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">代码无难事，只怕有心猿</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">24</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">21</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">42</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liuchuanv.github.io/2019/10/17/210-Java/Shiro/Shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSessionManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiuChuanWei">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="代码无难事">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Shiro源码解析之SessionManager
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-17 10:16:50" itemprop="dateCreated datePublished" datetime="2019-10-17T10:16:50Z">2019-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-30 01:28:36" itemprop="dateModified" datetime="2019-10-30T01:28:36Z">2019-10-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Shiro/" itemprop="url" rel="index">
                    <span itemprop="name">Shiro</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="了解-SessionManager"><a href="#了解-SessionManager" class="headerlink" title="了解 SessionManager"></a>了解 SessionManager</h2><h3 id="类继承图"><a href="#类继承图" class="headerlink" title="类继承图"></a>类继承图</h3><p><img src="/blog/images/201910/DefaultWebSessionManager.png" alt="DefaultWebSessionManager继承图"></p>
<blockquote>
<ul>
<li><em>在IDEA中选择某个类，按 <kbd>Shift</kbd>+<kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>U</kbd>生成类继承图；选择某个类，按 <kbd>F4</kbd>进入类</em></li>
<li><em>按<kbd>Alt</kbd>+<kbd>7</kbd>查看类的结构</em></li>
<li><em>按<kbd>Alt</kbd>+<kbd>F7</kbd>查看方法在哪里被调用了</em></li>
</ul>
<p>使用上面三个快捷键快捷查看框架源码</p>
</blockquote>
<p><strong>！！！记住上面的结构</strong></p>
<h3 id="SessionManager"><a href="#SessionManager" class="headerlink" title="SessionManager"></a>SessionManager</h3><p><img src="/blog/images/201910/1571280469834.png" alt="1571280469834"></p>
<h3 id="AbstractSessionManager"><a href="#AbstractSessionManager" class="headerlink" title="AbstractSessionManager"></a>AbstractSessionManager</h3><p>在源码注释中已经说明该类过时了，为了全局过期时间这个属性，而单独创建一个类是不必要的。</p>
<p><img src="/blog/images/201910/1571280571702.png" alt="1571280571702"></p>
<h3 id="AbstractNativeSessionManager"><a href="#AbstractNativeSessionManager" class="headerlink" title="AbstractNativeSessionManager"></a>AbstractNativeSessionManager</h3><p><img src="/blog/images/201910/1571281149103.png" alt="1571281149103"></p>
<h3 id="NativeSessionManger"><a href="#NativeSessionManger" class="headerlink" title="NativeSessionManger"></a>NativeSessionManger</h3><p><img src="/blog/images/201910/1571281440243.png" alt="NativeSessionManager"></p>
<h3 id="AbstractValidatingSessionManager"><a href="#AbstractValidatingSessionManager" class="headerlink" title="AbstractValidatingSessionManager"></a>AbstractValidatingSessionManager</h3><p><img src="/blog/images/201910/1571281647315.png" alt="1571281647315"></p>
<blockquote>
<p>注意：成员变量 <code>SessionValidationScheduler sessionValidationScheduler</code> 会话验证调度器，定时调用 <code>validateSessions()</code> 验证会话是否过期。</p>
</blockquote>
<p><a href="http://localhost:4000/blog/2019/10/18/210-Java/Shiro/Shiro源码解析之SessionManager03-SessionValidationScheduler" target="_blank" rel="noopener">理解 SessionValidationScheduler</a></p>
<h3 id="DefaultSessionManager"><a href="#DefaultSessionManager" class="headerlink" title="DefaultSessionManager"></a>DefaultSessionManager</h3><p>（省略私有变量的getter和setter）</p>
<p><img src="/blog/images/201910/1571281832489.png" alt="1571281832489"></p>
<ul>
<li><code>SessionFactory sessionFactory</code> 用来生成 Session对象</li>
<li><code>SessionDAO sessionDAO</code> 用来实现session的持久化</li>
<li><code>CacheManager cacheManager</code> 缓存管理器</li>
</ul>
<h3 id="DefaultWebSessionManager"><a href="#DefaultWebSessionManager" class="headerlink" title="DefaultWebSessionManager"></a>DefaultWebSessionManager</h3><p>（省略私有变量的getter和setter）</p>
<p><img src="/blog/images/201910/1571282013982.png" alt="1571282013982"></p>
<ul>
<li><code>Cookie sessionIdCookie</code> ，携带名为JSESSIONID的cookie</li>
<li><code>boolean sessionIdCookieEnable</code> 是否使用 sessionIdCookie 的方式</li>
<li><code>boolean sessionIdUrlRewritingEnable</code> 是否在URL中添加 JESSIONID 参数</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>在web应用中，shiro默认使用 <code>DefaultWebSessionManager</code>，它有4个重要对象</p>
<ul>
<li>SessionFactory</li>
<li>SessionDAO</li>
<li>CacheManager</li>
<li>SessionValidationScheduler</li>
</ul>
<p>前三者在 <code>DefaultSessionManager</code> 中定义， <code>SessionValidationScheduler</code> 在 <code>AbstractValidatingSessionManager</code> 中被定义。所以有关 <code>SessionFactory、SessionFactory、CacheManager</code> 的相关操作都会在 <code>DefaultSessionManager</code> 中调用它们的相应方法</p>
<p><code>SessionFactory</code> 只是简单的 <code>createSession()</code> ，具体详情参考 <a href="http://localhost:4000/blog/2019/10/18/210-Java/Shiro/Shiro源码解析之SessionManager01-Session" target="_blank" rel="noopener">Shiro源码解析之SessionManager01-Session</a> 中。<br><code>CacheManager</code> 在多个组件都有用到，会单独解析</p>
<h2 id="理解-SessionManager"><a href="#理解-SessionManager" class="headerlink" title="理解 SessionManager"></a>理解 SessionManager</h2><p><code>SessionManager</code>接口对外只有两个方法 <code>start()</code> 和 <code>getSession()</code>。我们一步步的来寻找它们的最终实现</p>
<h3 id="start-SessionContext-Session"><a href="#start-SessionContext-Session" class="headerlink" title="start(SessionContext): Session"></a>start(SessionContext): Session</h3><h4 id="1-AbstractNativeSessionManager-start"><a href="#1-AbstractNativeSessionManager-start" class="headerlink" title="1. AbstractNativeSessionManager | start()"></a>1. AbstractNativeSessionManager | <code>start()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 98</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Session <span class="title">start</span><span class="params">(SessionContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Session session = createSession(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置session的过期时间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    applyGlobalSessionTimeout(session);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    onStart(session, context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    notifyStart(session);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//Don't expose the EIS-tier Session object to the client-tier:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> createExposedSession(session, context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 161</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">createExposedSession</span><span class="params">(Session session, SessionContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DelegatingSession(<span class="keyword">this</span>, <span class="keyword">new</span> DefaultSessionKey(session.getId()));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">createExposedSession</span><span class="params">(Session session, SessionKey key)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DelegatingSession(<span class="keyword">this</span>, <span class="keyword">new</span> DefaultSessionKey(session.getId()));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 184</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Notifies any interested &#123;<span class="doctag">@link</span> SessionListener&#125;s that a Session has started.  This method is invoked</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * &lt;em&gt;after&lt;/em&gt; the &#123;<span class="doctag">@link</span> #onStart onStart&#125; method is called.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> session the session that has just started that will be delivered to any</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *                &#123;<span class="doctag">@link</span> #setSessionListeners(java.util.Collection) registered&#125; session listeners.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@see</span> SessionListener#onStart(org.apache.shiro.session.Session)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">notifyStart</span><span class="params">(Session session)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (SessionListener listener : <span class="keyword">this</span>.listeners) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        listener.onStart(session);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="2-AbstractValidatingSessionManager-createSession"><a href="#2-AbstractValidatingSessionManager-createSession" class="headerlink" title="2. AbstractValidatingSessionManager | createSession()"></a>2. AbstractValidatingSessionManager | <code>createSession()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 82</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enableSessionValidationIfNecessary</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    SessionValidationScheduler scheduler = getSessionValidationScheduler();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (isSessionValidationSchedulerEnabled() &amp;&amp; (scheduler == <span class="keyword">null</span> || !scheduler.isEnabled())) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        enableSessionValidation();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 133</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">createSession</span><span class="params">(SessionContext context)</span> <span class="keyword">throws</span> AuthorizationException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    enableSessionValidationIfNecessary();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> doCreateSession(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Session <span class="title">doCreateSession</span><span class="params">(SessionContext initData)</span> <span class="keyword">throws</span> AuthorizationException</span>;</span></pre></td></tr></table></figure>

<h4 id="3-DefaultSessionManager-doCreateSession"><a href="#3-DefaultSessionManager-doCreateSession" class="headerlink" title="3. DefaultSessionManager | doCreateSession()"></a>3. DefaultSessionManager | <code>doCreateSession()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 153</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">doCreateSession</span><span class="params">(SessionContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 调用 sessionFactory 创建 session 对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Session s = newSessionInstance(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        log.trace(<span class="string">"Creating session for host &#123;&#125;"</span>, s.getHost());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 调用 sessionDAO 存储 session 对象，并生成 sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    create(s);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">newSessionInstance</span><span class="params">(SessionContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> getSessionFactory().createSession(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Persists the given session instance to an underlying EIS (Enterprise Information System).  This implementation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * delegates and calls</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * &lt;code&gt;this.&#123;<span class="doctag">@link</span> SessionDAO sessionDAO&#125;.&#123;<span class="doctag">@link</span> SessionDAO#create(org.apache.shiro.session.Session) create&#125;(session);&lt;code&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> session the Session instance to persist to the underlying EIS.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(Session session)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        log.debug(<span class="string">"Creating new EIS record for new session instance ["</span> + session + <span class="string">"]"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    sessionDAO.create(session);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="4-DefaultWebSessionManager-onStart"><a href="#4-DefaultWebSessionManager-onStart" class="headerlink" title="4. DefaultWebSessionManager | onStart()"></a>4. DefaultWebSessionManager | <code>onStart()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 91</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">storeSessionId</span><span class="params">(Serializable currentId, HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (currentId == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        String msg = <span class="string">"sessionId cannot be null when persisting for subsequent requests."</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(msg);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    Cookie template = getSessionIdCookie();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    Cookie cookie = <span class="keyword">new</span> SimpleCookie(template);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    String idString = currentId.toString();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    cookie.setValue(idString);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    cookie.saveTo(request, response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    log.trace(<span class="string">"Set session ID cookie for session with id &#123;&#125;"</span>, idString);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 238</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Stores the Session's ID, usually as a Cookie, to associate with future requests.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> session the session that was just &#123;<span class="doctag">@link</span> #createSession created&#125;.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Session session, SessionContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 父类的 onStart 方法什么也没做</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">super</span>.onStart(session, context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!WebUtils.isHttp(context)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        log.debug(<span class="string">"SessionContext argument is not HTTP compatible or does not have an HTTP request/response "</span> +</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">                <span class="string">"pair. No session ID cookie will be set."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    HttpServletRequest request = WebUtils.getHttpRequest(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    HttpServletResponse response = WebUtils.getHttpResponse(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (isSessionIdCookieEnabled()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        Serializable sessionId = session.getId();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 将sessionId设置到cookie中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        storeSessionId(sessionId, request, response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        log.debug(<span class="string">"Session ID cookie is disabled.  No cookie has been set for new session with id &#123;&#125;"</span>, session.getId());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    request.removeAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_IS_NEW, Boolean.TRUE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h4 id="5-createExposedSession-Session-SessionKey-Session"><a href="#5-createExposedSession-Session-SessionKey-Session" class="headerlink" title="5. createExposedSession(Session, SessionKey): Session"></a>5. <code>createExposedSession(Session, SessionKey): Session</code></h4><p>看这个方法的名字：创建暴露的session</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">createExposedSession</span><span class="params">(Session session, SessionKey key)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DelegatingSession(<span class="keyword">this</span>, <span class="keyword">new</span> DefaultSessionKey(session.getId()));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这个返回的 <code>DelegatingSession</code> 对象只保存 sessionId。它的 <code>getAttribute()</code> 方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 137</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.apache.shiro.session.Session#getAttribute(Object key)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAttribute</span><span class="params">(Object attributeKey)</span> <span class="keyword">throws</span> InvalidSessionException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> sessionManager.getAttribute(<span class="keyword">this</span>.key, attributeKey);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><ol>
<li>如果开启了定时检查session是否有效，则开启定时任务（AbstractValidatingSessionManager）</li>
<li>使用 sessionFactory 创建 session（DefaultSessionManager）</li>
<li>使用 sessionDAO 存储 session，并生成sessionId（DefaultSessionManager）</li>
<li>设置session的全局过期时间（AbstractNativeSessionManager）</li>
<li>调用 onStart，web应用将 sessionId 存储到 cookie中（DefaultWebSessionManager）</li>
<li>调用 notifyStart()（AbstractNativeSessionManager）</li>
<li>创建一个向外暴露的 session —— DegegatingSession（AbstractNativeSessionManager）</li>
</ol>
<h3 id="getSession-SessionKey-Session"><a href="#getSession-SessionKey-Session" class="headerlink" title="getSession(SessionKey): Session"></a>getSession(SessionKey): Session</h3><h4 id="1-AbstractNativeSessionManager-getSession"><a href="#1-AbstractNativeSessionManager-getSession" class="headerlink" title="1. AbstractNativeSessionManager | getSession()"></a>1. AbstractNativeSessionManager | <code>getSession()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 139</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Session <span class="title">getSession</span><span class="params">(SessionKey key)</span> <span class="keyword">throws</span> SessionException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Session session = lookupSession(key);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> session != <span class="keyword">null</span> ? createExposedSession(session, key) : <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Session <span class="title">lookupSession</span><span class="params">(SessionKey key)</span> <span class="keyword">throws</span> SessionException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"SessionKey argument cannot be null."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> doGetSession(key);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 160    </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Session <span class="title">doGetSession</span><span class="params">(SessionKey key)</span> <span class="keyword">throws</span> InvalidSessionException</span>;</span></pre></td></tr></table></figure>
<blockquote>
<p>先不理第5行中的 <code>createExposedSession(session, key)</code> ，我们先就着 <code>doGetSession</code> 这条线向下追。</p>
</blockquote>
<h4 id="2-AbstractValidatingSessionManager-doGetSession"><a href="#2-AbstractValidatingSessionManager-doGetSession" class="headerlink" title="2. AbstractValidatingSessionManager | doGetSession()"></a>2. AbstractValidatingSessionManager | <code>doGetSession()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 113</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Session <span class="title">doGetSession</span><span class="params">(<span class="keyword">final</span> SessionKey key)</span> <span class="keyword">throws</span> InvalidSessionException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    enableSessionValidationIfNecessary();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    log.trace(<span class="string">"Attempting to retrieve session with key &#123;&#125;"</span>, key);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    Session s = retrieveSession(key);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        validate(s, key);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Looks up a session from the underlying data store based on the specified session key.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> key the session key to use to look up the target session.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@return</span> the session identified by &#123;<span class="doctag">@code</span> sessionId&#125;.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@throws</span> UnknownSessionException if there is no session identified by &#123;<span class="doctag">@code</span> sessionId&#125;.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Session <span class="title">retrieveSession</span><span class="params">(SessionKey key)</span> <span class="keyword">throws</span> UnknownSessionException</span>;</span></pre></td></tr></table></figure>

<p><code>doGetSession()</code> 又调用了 <code>retrieveSession()</code> 方法，而这个方法在 <code>AbstractValidatingSessionManager</code> 中是抽象的。先不急着去找谁实现了这个方法，看看它头上的注释。大意：通过指定的session key 在潜在的数据存储中查询session</p>
<blockquote>
<p><strong>之所以在AbstractValidatingSessionManager实现<code>doGetSession()</code>，就是为了调用一下<code>enableSessionValidationIfNecessary()</code>，这个方法用来开启验证session的定时任务</strong></p>
</blockquote>
<h4 id="3-DefaultSessionManager-retrieveSession"><a href="#3-DefaultSessionManager-retrieveSession" class="headerlink" title="3. DefaultSessionManager | retrieveSession()"></a>3. DefaultSessionManager | <code>retrieveSession()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 215</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">retrieveSession</span><span class="params">(SessionKey sessionKey)</span> <span class="keyword">throws</span> UnknownSessionException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Serializable sessionId = getSessionId(sessionKey);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (sessionId == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        log.debug(<span class="string">"Unable to resolve session ID from SessionKey [&#123;&#125;].  Returning null to indicate a "</span> +</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">                <span class="string">"session could not be found."</span>, sessionKey);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    Session s = retrieveSessionFromDataSource(sessionId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//session ID was provided, meaning one is expected to be found, but we couldn't find one:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        String msg = <span class="string">"Could not find session with ID ["</span> + sessionId + <span class="string">"]"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownSessionException(msg);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 235</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Session <span class="title">retrieveSessionFromDataSource</span><span class="params">(Serializable sessionId)</span> <span class="keyword">throws</span> UnknownSessionException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> sessionDAO.readSession(sessionId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>看来我们已经发现真相了，<code>getSession(SessionKey)</code> 实际上是调用 <code>sessionDAO.readSession(sessionId)</code> 获取session的，当其不为null时，则<code>AbstractNativeSessionManager</code> 调用 <code>createExposedSession()</code> 。</p>
<blockquote>
<p>因为 DefaultSessionManager 中有 SessionDAO 成员变量，所以在它内部获取 sessionDAO存储的session</p>
</blockquote>
<h4 id="4-createExposedSession-Session-SessionKey-Session"><a href="#4-createExposedSession-Session-SessionKey-Session" class="headerlink" title="4. createExposedSession(Session, SessionKey): Session"></a>4. <code>createExposedSession(Session, SessionKey): Session</code></h4><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>如果开启了定时检查session是否有效，则开启定时任务（AbstractValidatingSessionManager）</li>
<li>使用 sessionDAO 根据 sessionId 获取 session （DefaultSessionManager）</li>
<li>创建一个向外暴露的 session —— DegegatingSession（AbstractNativeSessionManager）</li>
</ol>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/blog/alipay-reward-image.jpg" alt="LiuChuanWei 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/blog/alipay-reward-image.jpg" alt="LiuChuanWei 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag"># 源码解析</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/10/16/210-Java/JavaSE/%E6%B5%85%E8%B0%88Java%E4%B8%AD%E5%87%A0%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84%E6%AF%94%E8%BE%83%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95/" rel="prev" title="【转载】Java中比较器的实现方法">
      <i class="fa fa-chevron-left"></i> 【转载】Java中比较器的实现方法
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/10/18/210-Java/Shiro/Shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B9%8BSessionManager02-SessionDAO/" rel="next" title="Shiro源码解析之SessionManager02-SessionDAO">
      Shiro源码解析之SessionManager02-SessionDAO <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#了解-SessionManager"><span class="nav-number">1.</span> <span class="nav-text">了解 SessionManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类继承图"><span class="nav-number">1.1.</span> <span class="nav-text">类继承图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SessionManager"><span class="nav-number">1.2.</span> <span class="nav-text">SessionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractSessionManager"><span class="nav-number">1.3.</span> <span class="nav-text">AbstractSessionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractNativeSessionManager"><span class="nav-number">1.4.</span> <span class="nav-text">AbstractNativeSessionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NativeSessionManger"><span class="nav-number">1.5.</span> <span class="nav-text">NativeSessionManger</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AbstractValidatingSessionManager"><span class="nav-number">1.6.</span> <span class="nav-text">AbstractValidatingSessionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DefaultSessionManager"><span class="nav-number">1.7.</span> <span class="nav-text">DefaultSessionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DefaultWebSessionManager"><span class="nav-number">1.8.</span> <span class="nav-text">DefaultWebSessionManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">1.9.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#理解-SessionManager"><span class="nav-number">2.</span> <span class="nav-text">理解 SessionManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#start-SessionContext-Session"><span class="nav-number">2.1.</span> <span class="nav-text">start(SessionContext): Session</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-AbstractNativeSessionManager-start"><span class="nav-number">2.1.1.</span> <span class="nav-text">1. AbstractNativeSessionManager | start()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-AbstractValidatingSessionManager-createSession"><span class="nav-number">2.1.2.</span> <span class="nav-text">2. AbstractValidatingSessionManager | createSession()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-DefaultSessionManager-doCreateSession"><span class="nav-number">2.1.3.</span> <span class="nav-text">3. DefaultSessionManager | doCreateSession()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-DefaultWebSessionManager-onStart"><span class="nav-number">2.1.4.</span> <span class="nav-text">4. DefaultWebSessionManager | onStart()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-createExposedSession-Session-SessionKey-Session"><span class="nav-number">2.1.5.</span> <span class="nav-text">5. createExposedSession(Session, SessionKey): Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-1"><span class="nav-number">2.1.6.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getSession-SessionKey-Session"><span class="nav-number">2.2.</span> <span class="nav-text">getSession(SessionKey): Session</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-AbstractNativeSessionManager-getSession"><span class="nav-number">2.2.1.</span> <span class="nav-text">1. AbstractNativeSessionManager | getSession()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-AbstractValidatingSessionManager-doGetSession"><span class="nav-number">2.2.2.</span> <span class="nav-text">2. AbstractValidatingSessionManager | doGetSession()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-DefaultSessionManager-retrieveSession"><span class="nav-number">2.2.3.</span> <span class="nav-text">3. DefaultSessionManager | retrieveSession()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-createExposedSession-Session-SessionKey-Session"><span class="nav-number">2.2.4.</span> <span class="nav-text">4. createExposedSession(Session, SessionKey): Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">2.2.5.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiuChuanWei</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/liuchuanv" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liuchuanv" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiuChuanWei</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

</body>
</html>
