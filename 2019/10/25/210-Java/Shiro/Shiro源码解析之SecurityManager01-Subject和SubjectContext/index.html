<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>静言思之</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/lib/github-markdown-css/github-markdown.css">
</head>
<body>
<div class="container">
<header class="header">
    <div class="blog-title">
        <a href="/" class="logo">静言思之</a>
    </div>
    <nav class="navbar">
        <ul class="menu">
            
                <li class="menu-item">
                    <a href="/" class="menu-item-link">首页</a>
                </li>
            
                <li class="menu-item">
                    <a href="/archives" class="menu-item-link">归档</a>
                </li>
            
                <li class="menu-item">
                    <a href="https://github.com/ahonn" target="_blank" rel="noopener" class="menu-item-link">交友</a>
                </li>
            
        </ul>
    </nav>
</header>
<main class="main">
    <article class="post">
    <div class="post-title">
        <h2 class="title">shiro源码解析之Subject和SubjectContext</h2>
    </div>
    <div class="post-meta">
        <span class="post-time">2019-10-25</span>
    </div>
    <div class="markdown-body">
        <h1 id="解析Subject"><a href="#解析Subject" class="headerlink" title="解析Subject"></a>解析Subject</h1><h2 id="了解-Subject"><a href="#了解-Subject" class="headerlink" title="了解 Subject"></a>了解 Subject</h2><h3 id="继承图"><a href="#继承图" class="headerlink" title="继承图"></a>继承图</h3><p><img src="/blog/images/201910/image-20191025173100171.png" alt="WebDelegatingSubject继承图"></p>
<h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h3><p><img src="/blog/images/201910/image-20191025172729016.png" alt="Subject方法属性"></p>
<p><img src="/blog/images/201910/image-20191025172830698.png" alt="Subject内部类Builder的方法属性"></p>
<h3 id="DelegatingSubject"><a href="#DelegatingSubject" class="headerlink" title="DelegatingSubject"></a>DelegatingSubject</h3><p><img src="/blog/images/201910/image-20191025174237381.png" alt="DelegatingSubject方法属性"></p>
<h3 id="WebDelegatingSubject"><a href="#WebDelegatingSubject" class="headerlink" title="WebDelegatingSubject"></a>WebDelegatingSubject</h3><p><img src="/blog/images/201910/image-20191025174353930.png" alt="WebDelegatingSubject方法属性"></p>
<h2 id="分析-Subject"><a href="#分析-Subject" class="headerlink" title="分析 Subject"></a>分析 Subject</h2><p>在登录流程中，我们经常用到的方法有 <code>getPrincipal()</code> 、<code>getSession()</code>、<code>login()</code>、<code>logout</code></p>
<h3 id="getPrincipal-Object"><a href="#getPrincipal-Object" class="headerlink" title="getPrincipal(): Object"></a>getPrincipal(): Object</h3><p>该方法在 DelegatingSubject 实现</p>
<pre><code class="java">    private Object getPrimaryPrincipal(PrincipalCollection principals) {
        if (!isEmpty(principals)) {
            return principals.getPrimaryPrincipal();
        }
        return null;
    }

    /**
     * @see Subject#getPrincipal()
     */
    public Object getPrincipal() {
        return getPrimaryPrincipal(getPrincipals());
    }

    public PrincipalCollection getPrincipals() {
        List&lt;PrincipalCollection&gt; runAsPrincipals = getRunAsPrincipalsStack();
        return CollectionUtils.isEmpty(runAsPrincipals) ? this.principals : runAsPrincipals.get(0);
    }
    ......
    // line 169
    private List&lt;PrincipalCollection&gt; getRunAsPrincipalsStack() {
        Session session = getSession(false);
        if (session != null) {
            return (List&lt;PrincipalCollection&gt;) session.getAttribute(RUN_AS_PRINCIPALS_SESSION_KEY);
        }
        return null;
    }</code></pre>
<h3 id="getSession-Session"><a href="#getSession-Session" class="headerlink" title="getSession() : Session"></a>getSession() : Session</h3><p>该方法在 DelegatingSubject 中实现的</p>
<pre><code class="java">    // line 314
    public Session getSession() {
        return getSession(true);
    }

    public Session getSession(boolean create) {
        if (log.isTraceEnabled()) {
            log.trace(&quot;attempting to get session; create = &quot; + create +
                    &quot;; session is null = &quot; + (this.session == null) +
                    &quot;; session has id = &quot; + (this.session != null &amp;&amp; session.getId() != null));
        }

        if (this.session == null &amp;&amp; create) {

            //added in 1.2:
            if (!isSessionCreationEnabled()) {
                String msg = &quot;Session creation has been disabled for the current subject.  This exception indicates &quot; +
                        &quot;that there is either a programming error (using a session when it should never be &quot; +
                        &quot;used) or that Shiro&#39;s configuration needs to be adjusted to allow Sessions to be created &quot; +
                        &quot;for the current Subject.  See the &quot; + DisabledSessionException.class.getName() + &quot; JavaDoc &quot; +
                        &quot;for more.&quot;;
                throw new DisabledSessionException(msg);
            }

            log.trace(&quot;Starting session for host {}&quot;, getHost());
            SessionContext sessionContext = createSessionContext();
            Session session = this.securityManager.start(sessionContext);
            this.session = decorate(session);
        }
        return this.session;
    }

    protected SessionContext createSessionContext() {
        SessionContext sessionContext = new DefaultSessionContext();
        if (StringUtils.hasText(host)) {
            sessionContext.setHost(host);
        }
        return sessionContext;
    }</code></pre>
<p><code>getSession()</code> 等同于 <code>getSession(true)</code> ，如果 session 不存在，则创建一个  </p>
<h1 id="解析SubjectContext"><a href="#解析SubjectContext" class="headerlink" title="解析SubjectContext"></a>解析SubjectContext</h1><h2 id="了解SubjectContext"><a href="#了解SubjectContext" class="headerlink" title="了解SubjectContext"></a>了解SubjectContext</h2><h3 id="继承图-1"><a href="#继承图-1" class="headerlink" title="继承图"></a>继承图</h3><p><img src="/blog/images/201910/image-20191025155513614.png" alt="DefaultSubjectContext继承图"></p>
<h3 id="SubjectContext"><a href="#SubjectContext" class="headerlink" title="SubjectContext"></a>SubjectContext</h3><p><img src="/blog/images/201910/image-20191025160223932.png" alt="SubjectContext属性方法"></p>
<h3 id="MapContext"><a href="#MapContext" class="headerlink" title="MapContext"></a>MapContext</h3><p><img src="/blog/images/201910/image-20191025164140561.png" alt="MapContext属性方法"></p>
<h3 id="DefaultSubjectContext"><a href="#DefaultSubjectContext" class="headerlink" title="DefaultSubjectContext"></a>DefaultSubjectContext</h3><p><img src="/blog/images/201910/image-20191025164706628.png" alt="DefaultSubjectContext属性方法"></p>
<h3 id="DefaultWebSubjectContext"><a href="#DefaultWebSubjectContext" class="headerlink" title="DefaultWebSubjectContext"></a>DefaultWebSubjectContext</h3><p><img src="/blog/images/201910/image-20191025164829210.png" alt="DefaultWebSubjectContext属性方法"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>MapContext 的Map对象 backingMap 专门用来保存各种类型的变量，看它的定义就可明白 </p>
<pre><code class="java">    private final Map&lt;String, Object&gt; backingMap;

    public MapContext() {
        this.backingMap = new HashMap&lt;String, Object&gt;();
    }</code></pre>
<p>而 DefaultSubjectContext 和 DefaultWebSubjectContext 继承了这一点，并在此基础上添加了多个 setter 和 getter ，用来向map添加元素，以及从map中获取元素。</p>
<p>但是要注意名称如 resolveXxx 这样的方法。</p>
<h2 id="理解-SubjectContext"><a href="#理解-SubjectContext" class="headerlink" title="理解 SubjectContext"></a>理解 SubjectContext</h2><h3 id="setXxx-方法"><a href="#setXxx-方法" class="headerlink" title="setXxx 方法"></a>setXxx 方法</h3><pre><code class="java">    public void setSecurityManager(SecurityManager securityManager) {
        nullSafePut(SECURITY_MANAGER, securityManager);
    }</code></pre>
<p>nullSafePut(String, Object) 方法继承自 MapContext</p>
<pre><code class="java">    // line 73
    /**
     * Places a value in this context map under the given key only if the given {@code value} argument is not null.
     *
     * @param key   the attribute key under which the non-null value will be stored
     * @param value the non-null value to store.  If {@code null}, this method does nothing and returns immediately.
     */
    protected void nullSafePut(String key, Object value) {
        if (value != null) {
            put(key, value);
        }
    }
    ......
    // line 105
    public Object put(String s, Object o) {
        return backingMap.put(s, o);
    }</code></pre>
<p>setXxx 方法就是将 Xxx 添加到 backingMap 中</p>
<h3 id="getXxx-方法"><a href="#getXxx-方法" class="headerlink" title="getXxx 方法"></a>getXxx 方法</h3><pre><code class="java">    public SecurityManager getSecurityManager() {
        return getTypedValue(SECURITY_MANAGER, SecurityManager.class);
    }</code></pre>
<p>getTypedValue 同样继承自 MapContext</p>
<pre><code class="java">    // line 48
    /**
     * Performs a {@link #get get} operation but additionally ensures that the value returned is of the specified
     * {@code type}.  If there is no value, {@code null} is returned.
     *
     * @param key  the attribute key to look up a value
     * @param type the expected type of the value
     * @param &lt;E&gt;  the expected type of the value
     * @return the typed value or {@code null} if the attribute does not exist.
     */
    @SuppressWarnings({&quot;unchecked&quot;})
    protected &lt;E&gt; E getTypedValue(String key, Class&lt;E&gt; type) {
        E found = null;
        Object o = backingMap.get(key);
        if (o != null) {
            if (!type.isAssignableFrom(o.getClass())) {
                String msg = &quot;Invalid object found in SubjectContext Map under key [&quot; + key + &quot;].  Expected type &quot; +
                        &quot;was [&quot; + type.getName() + &quot;], but the object under that key is of type &quot; +
                        &quot;[&quot; + o.getClass().getName() + &quot;].&quot;;
                throw new IllegalArgumentException(msg);
            }
            found = (E) o;
        }
        return found;
    }</code></pre>
<p> getXxx 方法中调用 getTypedValue(String, Class) 。在该方法中，根据 key 从 backingMap 中获取值，然后判断该值是否是 Class 对象。</p>
<h3 id="resolveXxx-方法"><a href="#resolveXxx-方法" class="headerlink" title="resolveXxx 方法"></a>resolveXxx 方法</h3><h4 id="resolveSecurityManager"><a href="#resolveSecurityManager" class="headerlink" title="resolveSecurityManager()"></a>resolveSecurityManager()</h4><pre><code class="java">    // line 96
    public SecurityManager resolveSecurityManager() {
        SecurityManager securityManager = getSecurityManager();
        if (securityManager == null) {
            if (log.isDebugEnabled()) {
                log.debug(&quot;No SecurityManager available in subject context map.  &quot; +
                        &quot;Falling back to SecurityUtils.getSecurityManager() lookup.&quot;);
            }
            try {
                securityManager = SecurityUtils.getSecurityManager();
            } catch (UnavailableSecurityManagerException e) {
                if (log.isDebugEnabled()) {
                    log.debug(&quot;No SecurityManager available via SecurityUtils.  Heuristics exhausted.&quot;, e);
                }
            }
        }
        return securityManager;
    }
</code></pre>
<p>先调用 <code>getSecurityManager()</code> 从 backingMap 中获取对象；</p>
<p>为空的话，则调用 <code>SecurityUtils.getSecurityManager()</code></p>
<h4 id="resolveSession"><a href="#resolveSession" class="headerlink" title="resolveSession()"></a>resolveSession()</h4><pre><code class="java">    public Session resolveSession() {
        Session session = getSession();
        if (session == null) {
            //try the Subject if it exists:
            Subject existingSubject = getSubject();
            if (existingSubject != null) {
                session = existingSubject.getSession(false);
            }
        }
        return session;
    }</code></pre>
<ul>
<li>先调用 <code>getSession()</code> 从 backingMap 中获取对象；</li>
<li>为空的话，则去 subject 中获取</li>
</ul>
<h4 id="resolvePrincipals"><a href="#resolvePrincipals" class="headerlink" title="resolvePrincipals()"></a>resolvePrincipals()</h4><pre><code class="java">public PrincipalCollection resolvePrincipals() {
        PrincipalCollection principals = getPrincipals();

        if (isEmpty(principals)) {
            //check to see if they were just authenticated:
            AuthenticationInfo info = getAuthenticationInfo();
            if (info != null) {
                principals = info.getPrincipals();
            }
        }

        if (isEmpty(principals)) {
            Subject subject = getSubject();
            if (subject != null) {
                principals = subject.getPrincipals();
            }
        }

        if (isEmpty(principals)) {
            //try the session:
            Session session = resolveSession();
            if (session != null) {
                principals = (PrincipalCollection) session.getAttribute(PRINCIPALS_SESSION_KEY);
            }
        }

        return principals;
    }
</code></pre>
<ul>
<li>先调用 <code>getPrincipals()</code> 从 backingMap 中获取对象；</li>
<li>为空的话，则去<strong><code>AuthenticationInfo</code></strong>对象中获取；</li>
<li>还为空的话，则去<strong><code>Subject</code></strong>对象中获取；</li>
<li>还为空的话，则去<strong><code>Session</code></strong>对象中获取。</li>
</ul>

    </div>
</article>
</main>
</div>
</body>
</html>